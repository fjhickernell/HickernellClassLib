# Confidence Intervals

If

- $\theta$ is a parameter of interest of a distribution, and

- $X_1, \ldots, X_n$ are data that we assume are collected from that distribution,

then we try to construct random quantities $\Theta_L$ and/or $\Theta_U$,
depending only on the data (and not on $\theta$), that give intervals which
[capture]{.alert} $\theta$ with high probability $1-\alpha$.  Depending on the situation, this means constructing

- a two-sided interval with  $\Prob(\Theta_L \le \theta \le \Theta_U) \ge 1-\alpha$, or

- a one-sided lower interval with  $\Prob(\Theta_L \le \theta) \ge 1-\alpha$, or

- a one-sided upper interval with  $\Prob(\theta \le \Theta_U) \ge 1-\alpha$

The bounds $\Theta_L$ and $\Theta_U$ are random because they depend on random data. Here $\alpha$ is our willingness to be wrong, typically $\alpha = 5\%$.

- In many continuous cases, the probability is exactly $1-\alpha$
- For discrete distributions, the probability is often slightly larger than $1-\alpha$

---

- [Large sample size confidence intervals for means](#large-sample-confidence-intervals-for-means)
- [Small sample size confidence intervals for means when the distribution is known](#small-sample-confidence-intervals-for-means-when-the-distribution-is-known)

## Large sample size confidence intervals for means{#large-sample-confidence-intervals-for-means}   
If $X_1, \ldots, X_n$ are IID with mean $\mu$ and variance $\sigma^2 < \infty$, and $\barX$ is the sample mean, then by the [Central Limit Theorem](../slides/01-intro.html#clt)
$$
\frac{\barX - \mu}{\sigma/\sqrt{n}} \appxsim \Norm(0,1) \quad \text{for large } n
$$
Letting $z_{\alpha/2}$ be the upper $\alpha/2$ quantile of $\Norm(0,1)$, i.e., $z_{\alpha/2} = Q_{\Norm(0,1)}(1 - \alpha/2)$, then
\begin{align*}
1 - \alpha & \approx
\Prob \biggl( -z_{\alpha/2} \le \frac{\barX - \mu}{\sigma/\sqrt{n}} \le z_{\alpha/2} \biggr) \\
& \approx \Prob \biggl( \barX - z_{\alpha/2} \frac{\sigma}{\sqrt{n}} \le \mu \le \barX + z_{\alpha/2} \frac{\sigma}{\sqrt{n}} \biggr) \\
& \approx \Prob \biggl( \underbrace{\barX - z_{\alpha/2} \frac{S}{\sqrt{n}}}_{\Theta_L} \le \mu \le \underbrace{\barX + z_{\alpha/2} \frac{S}{\sqrt{n}}}_{\Theta_U} \biggr)
\end{align*}
where $S^2$ is some estimate of the unknown population variance $\sigma^2$ (e.g., unbiased or MLE)

---

See the [Approval Ratings](../slides/01-intro.html#approval-ratings) example for an illustration of this construction for a Bernoulli mean

```{python}

#| echo: false
#| output: asis

import math
import scipy.stats as st

# =========================
# Parameters (edit HERE)
# =========================
n_small = 16
n_large = 400

xbar = 12.0
alpha = 0.05

# =========================
# CI helpers
# =========================

def ci_exp_exact_mu(n, xbar, alpha=0.05):
    """Exact CI for Exp mean via chi-square."""
    df = 2*n
    q_lo = st.chi2.ppf(alpha/2, df)
    q_hi = st.chi2.ppf(1 - alpha/2, df)
    return (2*n*xbar)/q_hi, (2*n*xbar)/q_lo

def ci_clt_exp_mu(n, xbar, alpha=0.05):
    """
    CLT CI for Exp mean using plug-in sigma_hat = xbar.
    """
    z = st.norm.ppf(1 - alpha/2)
    se = xbar / math.sqrt(n)
    return xbar - z*se, xbar + z*se

def fmt_ci(lo, hi, digits=2):
    return f"$[{lo:.{digits}f},\\,{hi:.{digits}f}]$"

print(
    f"_Example_: You observe $\\barX_n = {xbar}$ minutes for taxis to arrive."
    f"You construct a ${100*(1-alpha):.0f}\\%$ confidence interval for the mean arrival time, $\\mu$, assuming that the arrival times are distributed  $\\Exp(1/\\mu)$.  Recall that $\\mu = \\sigma = 1/\\lambda$.\n"
)

print("| $n$ | *CLT* CI for $\\mu$ ($S=\\barX_{n}$) | CI width |")
print("|---:|:---:|---:|")
for n in (n_small, n_large):
    lo, hi = ci_clt_exp_mu(n, xbar, alpha)
    width = hi - lo
    print(f"| {n} | {fmt_ci(lo, hi)} | {width:.3f} |")

```

---

## Small sample size confidence intervals for means when the distribution is known{#small-sample-confidence-intervals-for-means-when-the-distribution-is-known}

If the sample size is not large enough for the [Central Limit Theorem](../slides/01-intro.html#clt) to apply, but the sample mean has a known distribution, then exact confidence intervals can sometimes be constructed

```{python}
#| echo: false
#| output: asis

print(
    f"_Example_: You observe $\\barX_n = {xbar}$ minutes for taxis to arrive."
    f"based on $n$. You construct a ${100*(1-alpha):.0f}\\%$ confidence interval for the mean arrival time, $\\mu$, assuming that the arrival times are distributed  $\\Exp(1/\\mu)$.  Recall that $\\mu = \\sigma = 1/\\lambda$. \n \n But now we have the true distribution of $\\barX_n$:"
)
```

\begin{align*}
2 \lambda n \barX_n \sim \chi^2_{2n} \implies 1 - \alpha &= \Prob \biggl( \chi^2_{2n, \alpha/2} \le 2 \lambda n \barX_n \le \chi^2_{2n, 1-\alpha/2} \biggr) \\
& = \Prob \biggl( \frac{\chi^2_{2n, \alpha/2}}{2 n \barX_n} \le \lambda \le \frac{\chi^2_{2n, 1-\alpha/2}}{2 n \barX_n} \biggr) \\
& = \Prob \biggl( \frac{2 n \barX_n}{\chi^2_{2n, 1-\alpha/2}} \le \mu \le \frac{2 n \barX_n}{\chi^2_{2n, \alpha/2}} \biggr)
\end{align*}

---
```{python}
#| echo: false
#| output: asis

print("| $n$ | *Exact* $\\chi^2$ CI | *Exact* CI width | *CLT* CI | *CLT* CI width | (CLT width/<br>Exact width) |")
print("|-:|:---:|----:|:---:|----:|-----:|")

for n in (n_small, n_large):
    clt_lo, clt_hi = ci_clt_exp_mu(n, xbar, alpha)
    ex_lo, ex_hi   = ci_exp_exact_mu(n, xbar, alpha)

    w_clt = clt_hi - clt_lo
    w_ex  = ex_hi - ex_lo

    print(
        f"| {n} | {fmt_ci(ex_lo, ex_hi)} | {w_ex:.3f} | "
        f"{fmt_ci(clt_lo, clt_hi)} | {w_clt:.3f} | {w_clt/w_ex:.3f} |"
    )

```

- For small $n$
  - Exact confidence interval can be substantially different from the CLT-based interval
  - CLT is symmetric about $\barX_n$, while the exact interval is not
- As $n$ increases, CLT-based interval approaches the exact interval

::: {.exitem}
<span class="exbullet">$\exstar$</span><span> You draw $n$ IID samples of your product to test for failure.  What is your confidence interval for $p$, the probability of a satisfactory product, if none of the samples fail?</span>
:::